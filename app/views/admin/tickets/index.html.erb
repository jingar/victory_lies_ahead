<% provide(:title, "Tickets") %>
<head>
  <h2> Tickets </h2>
</head>
<body>
	<form class="navbar-search pull-left">
	  <%= form_tag admin_tickets_path, :method => 'get' do %>
	  <p>
            <%= text_field_tag :search, params[:search],{placeholder: 'Seach for tickets by Order ID', class: 'search-query'} %>
            <%= submit_tag "Search", :order_id => nil, class:'btn btn-small btn-primary' %><br/>
	  </p>
	  <% end %>
	</form>
	<div align = "right">
	  <p><%= link_to "New ticket", new_admin_ticket_path %></p>
	  <p><%= link_to "Back to Dashboard", admin_path %></p>
	</div>
	<table class ="table table-striped" border = "3" cellpadding = "3" align = "center">
  		<thead>
			<tr>
			  <th><%= sortable  "first_name", Ticket, "First Name" %></th>
			  <th><%= sortable "last_name", Ticket, "Last Name" %></th>
			  <th><%= sortable "email", Ticket, "Email Address" %></th>
			  <th><%= sortable "address", Ticket, "Address" %></th>
			  <th><%= sortable "order_id", Ticket, "Order ID" %></th>
			  <th><%= sortable "ticket_type", Ticket, "Ticket Type" %></th>
			  <th><%= sortable "ticket_date", Ticket, "Ticket Expiry Date " %></th>
			  <th><%= sortable "adult_tickets_bought", Ticket, "Adult Tickets Bought" %></th>
			  <th><%= sortable "concession_tickets_bought", Ticket, "Concession Tickets Bought" %></th>
			  <th><%= sortable "total_ticket_cost", Ticket, "Total Ticket Cost" %></th>
			  <th><%= sortable "used", Ticket, "Ticket Status" %></th>
			  <th><%= sortable "id", Ticket, "Options" %></th>
			</tr>
      	</thead>
		<tbody>
			<% for ticket in @tickets %>
			<% a = ticket.order_id %>
			<tr>
			  <td><%= ticket.first_name %></td>
			  <td><%= ticket.last_name %></td>
			  <td><%= ticket.email %></td>
			  <td><%= ticket.address %></td>
			  <td><%= ticket.order_id %></td>
			  <td><%= ticket.ticket_type %></td>
			  <td><%= ticket.ticket_date %></td>
			  <td><%= ticket.adult_tickets_bought %></td>
			  <td><%= ticket.concession_tickets_bought %></td>
			  <td>£<%= calculate_total_cost(10,5,ticket.order_id) %></td>
			  <td><%= ticket.used %></td>
			  <% if !(ticket.used == "Expired") %>
			  <td><%= link_to 'Change', admin_activate_ticket_path(ticket), confirm: 'Are you Sure? Once activated this ticket cannot be deactivated' %></td>
			  <% end %>
			</tr>
      		</tbody>
      		<% end %>
    </table>
</body>

<h1> Sales Report </h1>

<table class ="table table-striped" border = "3" cellpadding = "3" align = "center">
    <tr bgcolor="grey">
        <th>Number of Adult Tickets Sold</th>
        <th>Number of Concession Tickets Sold</th>
        <th>Adult Income (£) </th>
        <th>Concession Income (£) </th>
    </tr>
    <% @tickets2.each do |t| %>
    <% if t.ticket_type != "Free" %>
        <% @adult += t.adult_tickets_bought %>
        <% @concession += t.concession_tickets_bought %>
        <% @adult * 5 %>
        <% @concession * 3 %>
	<% end %>
    <% end %>
        <tr>
            <td><%= @adult %></td>
            <td><%= @concession %></td>
            <td><%= @adult * 5 %></td>
            <td><%= @concession *3 %></td>
        </tr>
        <% @total += (@adult*5) + (@concession*3) %>
    
</table>

<h2> Total: £ <%= @total %></h2>


<h2>Number Of tickets Sold By Date </h2>

<table class ="table table-striped" border = "3" cellpadding = "3" align = "center">
  <% unique_ticket_dates = Ticket.count(group: :ticket_date).keys %>
  <tr>
    <% unique_ticket_dates.each do |t_dates| %>
    <th><%= t_dates.strftime("%A, %b %d") %></th>
    <% end %>
  </tr>
  <tr>
    <% unique_ticket_dates.each do |t| %>
    <% adult_tickets = Ticket.where(["ticket_date = ?",t]).sum(:adult_tickets_bought) %>
    <% concession_tickets = Ticket.where(["ticket_date = ?",t]).sum(:concession_tickets_bought) %>
    <% total_tickets = adult_tickets + concession_tickets %>
    <td><%= total_tickets %></td>
    <% end %>
  </tr>
</table>




